<!DOCTYPE html>
<html lang="en-us">
  <head>

    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>Recepty pre gorutiny a kanály -- worker pool | robonovotny</title>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.3/styles/dracula.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.3/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.3/languages/go.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="https://novotnyr.github.io/asciidoctor.css">
    <header>

  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://novotnyr.github.io/">~/robonovotny</a>
      </li>
      

      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Recepty pre gorutiny a kanály &ndash; worker pool</span></h1>

<h2 class="date">2023/01/15</h2>
<p class="terms">
  
  
  
  
  
</p>
</div>


<div class="content-wrapper">
  <main>
    <div class="paragraph">
<p>Minule sme vážili zvieratá na viacerých gorutinách.
Ukážme si situáciu, keď máme <strong>worker pool</strong>, teda bank konkrétneho počtu gorutín, ktoré si vyberajú robotu zo spoločného frontu, spracovávajú a výsledky posielajú do nového spoločného frontu.</p>
</div>
<div class="paragraph">
<p>Začnime opäť vážiť zvieratá.</p>
</div>
<div class="sect1">
<h2 id="_kostra">Kostra</h2>
<div class="sectionbody">
<div class="paragraph">
<p>V kostre si len vytvorme kanál pre zvieratá, do ktorého budeme posielať jedince súce na váženie.</p>
</div>
<div class="paragraph">
<p>Rovno povedzme, že toto skončí deadlockom.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">package main

func streamWork(animalChan chan&lt;- Animal) {
	for _, animal := range animals {
		animalChan &lt;- animal <i class="conum" data-value="2"></i><b>(2)</b>
	}
	close(animalChan) <i class="conum" data-value="3"></i><b>(3)</b>
}

func main() {
	animalChan := make(chan Animal) <i class="conum" data-value="1"></i><b>(1)</b>
	streamWork(animalChan) <i class="conum" data-value="4"></i><b>(4)</b>
}

type Animal struct {
	species string
	weight  int
}

var animals = []Animal{
	Animal{&#34;slon&#34;, 12},
	Animal{&#34;hroch&#34;, 4},
	Animal{&#34;nosorožec&#34;, 4},
	Animal{&#34;žirafa&#34;, 2},
	Animal{&#34;bizón&#34;, 2},
	Animal{&#34;veľryba&#34;, 190},
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nebufferovaný kanál, z ktorého si budú neskôr pracujúce gorutiny vyberať úlohy.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pošleme doňho zvieratá.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Na konci kanál zavrieme.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Zavoláme funkciu, ktorá pošle údaje so zvieratami do komunikačného nebufferovaného kanála.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Toto je samozrejme deadlock: z kanála nik nečíta a program obratom skončí.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_distribúcia_práce">Distribúcia práce</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Distribuujme teraz prácu cez „manažéra“, ktorý bude čítať z kanála úloh a rozdeľovať prácu.</p>
</div>
<div class="paragraph">
<p>Na začiatku ju rozdelí sám sebe.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func distributeWork(animalChan &lt;-chan Animal) { <i class="conum" data-value="1"></i><b>(1)</b>
	for animal := range animalChan {
		log.Printf(&#34;%v\n&#34;, animal)
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Čítame z kanála, kým sa kanál neuzavrie a zvieratá len vypisujeme.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Použitie v kóde? Dôležité je predísť deadlocku.</p>
</div>
<div class="paragraph">
<p>Keďže máme synchrónny nebufferovaný kanál, nemôžeme najprv posielať zvieratá na váženie a potom čakať na úlohy. To by bol jasný deadlock — producent by nemal konzumenta.</p>
</div>
<div class="paragraph">
<p>Nemôžeme to ani urobiť naopak, pretože by manažér-konzument čakal na producenta, ktorý by sa spustil až neskôr.</p>
</div>
<div class="paragraph">
<p>Rozseknime go-rdický uzol a spustime jednu z týchto súčiastok v gorutine — a zvoľme si za ňu funkciu, ktorá zaradí údaje do kanála.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func main() {
	animalChan := make(chan Animal)

	go streamWork(animalChan) <i class="conum" data-value="1"></i><b>(1)</b>
	distributeWork(animalChan) <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>V gorutine pustíme „prúd“ zvierat, ktoré sa ocitnú v komunikačnom kanáli.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Začneme distribuovať prácu.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Distribúcia práce vo funkcii <code>distributeWork</code> blokuje hlavnú gorutinu (a bráni predčasnému ukončeniu programu).</p>
</div>
<div class="paragraph">
<p>Distribúcia práce</p>
</div>
<div class="ulist">
<ul>
<li>
<p>priebežne čaká na zápis jednotlivých zvierat do <code>animalChan</code></p>
</li>
<li>
<p>zároveň očakáva koniec údajov v kanáli</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Deadlock však nenastáva — jednak pre komunikáciu medzi dvoma korutinami a zároveň kvôli jasnému explicitnému uzatvoreniu kanála.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_robotníci_pre_tri_gorutiny_vo_worker_pool">Robotníci pre tri gorutiny vo <em>Worker Pool</em>.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Začnime naozaj rozdeľovať prácu, a nielen simulovať!</p>
</div>
<div class="paragraph">
<p>Vytvorme si samostatnú funkciu pre robotnícku triedu, pardón, pre robotnícku funkciu.</p>
</div>
<div class="paragraph">
<p>Tá bude veľmi pomaly vážiť veľmi veľké zvieratá.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func worker(workerId int, animalChan &lt;-chan Animal) { <i class="conum" data-value="1"></i><b>(1)</b>
	for a := range animalChan { <i class="conum" data-value="2"></i><b>(2)</b>
		time.Sleep(1 * time.Second)
		log.Printf(&#34;[%d] %d\t%s\n&#34;, workerId, a.weight, a.species) <i class="conum" data-value="3"></i><b>(3)</b>
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Funkcia zoberie identifikátor (pre ladiace účely) a kanál, z ktorého bude načítavať zvieratá.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Zvieratá berieme z komunikačného kanála, kým sa kanál nezavrie.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Vážime a vypisujeme.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Kto zatvára kanál? Producent, teda funkcia <code>streamWork</code>. To je dôležitá obrana proti deadlocku.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Upravme aj manažment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func distributeWork(animalChan &lt;-chan Animal) {
	const workerCount = 3
	for i := 0; i &lt; workerCount; i++ {
		go worker(i, animalChan) <i class="conum" data-value="1"></i><b>(1)</b>
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Spusťme tri — nie viac, nie menej — gorutiny.
Pošlime im vstupný kanál.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Gorutiny budú súperiť o zvieratá v komunikačnom kanáli.
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_spusťme_firmu_na_zvieratá">Spusťme firmu na zvieratá</h3>
<div class="paragraph">
<p>Ak teraz spustíme <code>main</code>, neuvidíme nič.
Povaha <code>distributeWork</code> sa zmenila — už len vystrelí salvu gorutín, tak ako v predošlých životných situáciách, a okamžite skončí.</p>
</div>
<div class="paragraph">
<p>Keď to chceme urobiť hnusne, budeme čakať.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func main() {
	animalChan := make(chan Animal)

	go streamWork(animalChan)
	distributeWork(animalChan)

	time.Sleep(3 * time.Second) <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hnusne čakáme.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Výstup pošle dve salvy za sekundu. Sekundu totiž trvá, kým každý <code>worker</code> spracuje výsledok.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>2023/01/14 20:08:09 [2] 4       nosorožec
2023/01/14 20:08:09 [0] 12      slon
2023/01/14 20:08:09 [1] 4       hroch
2023/01/14 20:08:10 [2] 2       žirafa
2023/01/14 20:08:10 [1] 190     veľryba
2023/01/14 20:08:10 [0] 2       bizón</code></pre>
</div>
</div>
<div class="paragraph">
<p>Čakanie je však škaredé.</p>
</div>
<div class="paragraph">
<p>Ak chceme čakať na dobehnutie manažéra, znamená to čakať na koniec gorutín.
Je teda čas na <code>WaitGroup</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func distributeWork(animalChan &lt;-chan Animal) {
	const workerCount = 3

	var wg sync.WaitGroup
	wg.Add(workerCount) <i class="conum" data-value="1"></i><b>(1)</b>
	for i := 0; i &lt; workerCount; i++ {
		go func(workerId int) { <i class="conum" data-value="2"></i><b>(2)</b>
			worker(workerId, animalChan)
			wg.Done() <i class="conum" data-value="3"></i><b>(3)</b>
		}(i) <i class="conum" data-value="2"></i><b>(2)</b>
	}
	wg.Wait() <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pripravíme si <code>WaitGroup</code> s takým počtom gorutín, koľko máme robotníkov.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Spustíme v gorutine robotníka.
Použijeme vnorenú funkciu, do ktorej dopravíme identifikátor robotníka cez parameter, pretože využívame premennú <code>i</code> z iterácie.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Keď robotník skončí, znížime počítadlo vo <code>WaitGroup</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Čakáme, kým dobehnú všetky gorutiny.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Takto už nemusíme škaredo čakať:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func main() {
	animalChan := make(chan Animal)

	go streamWork(animalChan)
	distributeWork(animalChan)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Program skončí zhruba po 2 sekundách, keď dobehnú obe salvy troch gorutín.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_váženie_s_výsledkami">Váženie s výsledkami</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ak chceme, aby gorutiny komunikovali späť, použijeme recepty z predošlých dielov.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Funkcia <code>worker</code> bude posielať výsledky do samostatného kanála.</p>
</li>
<li>
<p>Funkcia <code>distributeWork</code>  bude čakať na výsledky.</p>
</li>
<li>
<p>A vytvoríme samostatnú funkciu na agregáciu výsledných váh.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_robotníčky_odpovedajú_do_kanála">Robotníčky odpovedajú do kanála</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func worker(workerId int,
            animalChan &lt;-chan Animal,
            weightChan chan&lt;- int) { <i class="conum" data-value="1"></i><b>(1)</b>
	for a := range animalChan {
		time.Sleep(1 * time.Second)
		log.Printf(&#34;[%d] %d\t%s\n&#34;, workerId, a.weight, a.species)
		weightChan &lt;- a.weight <i class="conum" data-value="2"></i><b>(2)</b>
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Očakávame tretí parameter: kanál pre navážené hmotnosti.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Každú hmotnosť zapíšeme do kanála.</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_agregácia_výsledkov">Agregácia výsledkov</h3>
<div class="paragraph">
<p>Agregácia výsledkov načíta údaje a zlúči:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func aggregateResults(weights &lt;-chan int) int {
	total := 0
	for weight := range weights {
		total += weight
	}
	return total
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_distribúcia_roboty_prekopaná">Distribúcia roboty prekopaná</h3>
<div class="paragraph">
<p>Musíme prekopať distribúciu práce:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Zavedieme výstupný kanál.</p>
</li>
<li>
<p>Počkáme na výsledky.</p>
</li>
<li>
<p>Agregujeme.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func distributeWork(animalChan &lt;-chan Animal) int {
	const workerCount = 3

	weights := make(chan int) <i class="conum" data-value="1"></i><b>(1)</b>
	var wg sync.WaitGroup
	wg.Add(workerCount)
	for i := 0; i &lt; workerCount; i++ {
		go func(workerId int) {
			worker(workerId, animalChan, weights) <i class="conum" data-value="2"></i><b>(2)</b>
			wg.Done()
		}(i)
	}
	go func() { <i class="conum" data-value="3"></i><b>(3)</b>
		wg.Wait()
		close(weights)
	}()

	return aggregateResults(weights) <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Vytvoríme kanál pre výstupné výsledky.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Robotnícka gorutina dostane výstupný kanál ako argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Čakáme na výsledky v samostatnej gorutine.
Toto je presne vzor z predošlého dielu.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ak dôjdu všetky dáta, agregujeme a výsledok vrátime z funkcie.</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_úprava_hlavnej_funkcie">Úprava hlavnej funkcie</h3>
<div class="paragraph">
<p>Samozrejme, musíme upraviť aj hlavnú funkciu:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func main() {
	animalChan := make(chan Animal)

	go streamWork(animalChan)
	total := distributeWork(animalChan) <i class="conum" data-value="1"></i><b>(1)</b>

	log.Printf(&#34;[T] %d\t%s\n&#34;, total, &#34;Total&#34;) <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Jednoducho rozdelíme robotu a získame výsledok.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Výsledok vypíšeme.</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_zhrnutie">Zhrnutie</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To je všetko, robota sa veselo rozdeľuje!</p>
</div>
<div class="paragraph">
<p>Ak odstránime čakanie vo funkcii <code>worker</code>, uvidíme priame a rýchle rátanie:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>2023/01/15 10:57:41 [1] 12      slon
2023/01/15 10:57:41 [1] 2       žirafa
2023/01/15 10:57:41 [0] 4       nosorožec
2023/01/15 10:57:41 [2] 4       hroch
2023/01/15 10:57:41 [2] 2       bizón
2023/01/15 10:57:41 [1] 190     veľryba
2023/01/15 10:57:41 [T] 214     Total</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vidíme, ako sa dáta tlačia do robotníkov: v tomto prípade prvý vybavil nosorožca, druhý odvážil slona, žirafu a veľrybu a posledný stihol hrocha a bizóna.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bonus_priamy_výpis_výsledkov">Bonus: Priamy výpis výsledkov</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ak chceme len priamy výpis výsledkov, kód sa zjednoduší.</p>
</div>
<div class="sect2">
<h3 id="_z_agregácie_je_len_výpis">Z agregácie je len výpis</h3>
<div class="paragraph">
<p>Z agregácie stačí robiť výpis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func processResults(resultChan &lt;-chan int) {
	for r := range resultChan {
		log.Printf(&#34;[R] %d\n&#34;, r)
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_distribúcia_potrebuje_výstupný_kanál">Distribúcia potrebuje výstupný kanál</h3>
<div class="paragraph">
<p>Distribúcia výsledkov potrebuje niekoľko zmien:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func distributeWork(animalChan &lt;-chan Animal, weights chan&lt;- int) { <i class="conum" data-value="1"></i><b>(1)</b>
	const workerCount = 3

	var wg sync.WaitGroup
	wg.Add(workerCount)
	for i := 0; i &lt; workerCount; i++ {
		go func(workerId int) {
			worker(workerId, animalChan, weights)
			wg.Done()
		}(i)
	}
	wg.Wait() <i class="conum" data-value="2"></i><b>(2)</b>
	close(weights) <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Žiadame aj výstupný kanál.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Čakáme na dobehnutie korutín.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ak všetky korutiny dobehli, zatvárame výstupný kanál.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Zatváranie a čakanie už nemusíme robiť v samostatnej korutine.
Konzumovať budeme z <em>inej</em> korutiny, ktorá bude blokovať pri čítaní výsledkov.</p>
</div>
<div class="paragraph">
<p>Deadlock nenastane, keďže <code>distributeWork</code> a čítanie z výsledkov pobežia v odlišných gorutinách.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_upravená_funkcia_main">Upravená funkcia <code>main</code></h3>
<div class="paragraph">
<p>Funkcia <code>main</code> spustí trojicu aktérov:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>zápis vstupných údajov pobeží v gorutine</p>
</li>
<li>
<p>rozdelenie roboty pobeží v samostatnej gorutine</p>
</li>
<li>
<p>čakanie na výsledky pobeží v hlavnej gorutine, kde súčasne blokuje predčasné ukončenie programu a zároveň blokuje pri čítaní z výsledkov.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func main() {
	animalChan := make(chan Animal) <i class="conum" data-value="1"></i><b>(1)</b>
	weightChan := make(chan int)

	go streamWork(animalChan)
	go distributeWork(animalChan, weightChan) <i class="conum" data-value="2"></i><b>(2)</b>
	processResults(weightChan) <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Vytvoríme kanál pre výsledky.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pošleme ho do rozdeľovania roboty.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Spracovávame výsledky, kde blokujeme.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Nezabudnime skontrolovať, kedy sa zatvorí výstupný kanál, ktorý prechádzame vo funkcii <code>processResult</code>.</p>
</div>
<div class="paragraph">
<p>To sa stane po dobehnutí všetkých robotníckych gorutín, čo znamená koniec vstupných dát a teda koniec výsledkov.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>

    <a href="/"> >> Home</a>
  </main>
</div>
    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
    </footer>
  </body>
</html>

