<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vytváranie webových aplikácií pomocou Spring MVC 2.5 | robonovotny</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="https://novotnyr.github.io/asciidoctor.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js" integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js" integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body);
        });
    </script>

<header>

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://novotnyr.github.io/">/home/robonovotny</a>
      </li>
      

      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Vytváranie webových aplikácií pomocou Spring MVC 2.5</span></h1>

<h2 class="date">2008/11/20</h2>
<p class="terms">
  
  
  
  
  
</p>
</div>



<main>


<h1 id="úvod">Úvod</h1>

<p>Spring MVC je už pomerne zaužívaný aplikačný rámec na vývoj webových aplikácií. Už jeho prvé verzie brali do úvahy skúsenosti a poučenia z iných MVC frameworkov. Navyše, s každou ďalšou verziou boli prezentované možnosti, ktoré prácu s ním ešte viac zjednodušili či uľahčili.</p>

<p>Vo verzii 2.5 je k dispozícii možnosť vytvárať webové aplikácie, ktoré dávajú väčší dôraz na zásadu, že dohoda je niekedy lepšia ako konfigurácia. Dodržiavanie menných konvencií a hojné použitie anotácií umožňuje vytvárať webové aplikácie založené na klasických Java triedach (POJO) s minimálnym množstvom konfigurácie.</p>

<p>Ukážme si príklad použitia na jednoduchej webovej aplikácii, ktorá bude vykonávať štyri základné operácie nad triedou reprezentujúcou študenta. Tieto operácie sú v skratke označované ako CRUD:</p>

<ul>
<li><em>Create</em> - vytvorenie objektu a uloženie v databáze</li>
<li><em>Read</em> - prezeranie objektu</li>
<li><em>Update</em> - aktualizácia údajov</li>
<li><em>Delete</em> - odstránenie objektu.</li>
</ul>

<h1 id="doménové-objekty-webovej-aplikácie">Doménové objekty webovej aplikácie</h1>

<p>Trieda študenta je klasický Java bean:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f00;background-color:#faa">public class </span>Student {
  <span style="color:#666;font-style:italic">/**
</span><span style="color:#666;font-style:italic">   * Id študenta.
</span><span style="color:#666;font-style:italic">   */</span>
  <span style="color:#f00;background-color:#faa">private Long </span>id;
  <span style="color:#666;font-style:italic">/**
</span><span style="color:#666;font-style:italic">   * Krstné meno študenta.
</span><span style="color:#666;font-style:italic">   */</span>
  <span style="color:#f00;background-color:#faa">private String </span>firstName;
  <span style="color:#666;font-style:italic">/**
</span><span style="color:#666;font-style:italic">   * Priezvisko študenta. 
</span><span style="color:#666;font-style:italic">   */</span>
  <span style="color:#f00;background-color:#faa">private String </span>lastName;

  <span style="color:#f00;background-color:#faa">private int </span>year;
  <span style="color:#666;font-style:italic">/**
</span><span style="color:#666;font-style:italic">   * Dátum narodenia študenta.
</span><span style="color:#666;font-style:italic">   */</span>
  <span style="color:#f00;background-color:#faa">private Date </span>birthDate;


  <span style="color:#666;font-style:italic">/* gettre, settre, konštruktory, hashCode() a equals() */</span>
}</code></pre></div>
<p>Každý študent má jednoznačný identifikátor typu <code>java.lang.Long</code>. (Použitie objektového typu namiesto primitívu má niekoľko výhod, ktoré sa ukážu neskôr.)</p>

<h1 id="stiahnutie-knižníc">Stiahnutie knižníc</h1>

<p>Základná štruktúra webovej aplikácie sa ničím nelíši od inej webovej aplikácie (základom je adresár <code>WEB-INF</code> s podadresármi <code>classes</code> a <code>lib</code>). Dôležité je získať knižnice pre Spring, ktoré získame zo stránok Springu. Okrem nej budeme potrebovať niektoré ďalšie JAR knižnice.
V adresári <code>WEB-INF/lib</code> by sa mal nachádzať:</p>

<ul>
<li>z projektu Spring:

<ul>
<li><code>spring.jar</code></li>
<li><code>spring-webmvc.jar</code></li>
</ul></li>

<li><p>z projektu <a href="http://commons.apache.org/downloads/download_logging.cgi">Jakarta Commons Logging</a></p>

<ul>
<li><code>commons-logging-1.1.1.jar</code></li>
</ul></li>

<li><p>z projektu <a href="http://jakarta.apache.org/site/downloads/downloads_taglibs-standard.cgi">Jakarta Standard Taglibs</a></p>

<ul>
<li><code>jstl.jar</code></li>
<li><code>standard.jar</code></li>
</ul></li>
</ul>

<p>V prípade, že používame Tomcat 6.x, sa tieto dve knižnice nachádzajú v inštalačnom podadresári <code>webapps/examples/WEB-INF/lib</code>.
  Tieto knižnice by sme mali dodať aj do <code>CLASSPATH</code>u, resp. do projektu v svojom obľúbenom vývojom prostredí.</p>

<h1 id="konfigurácia">Konfigurácia</h1>

<h2 id="popisovač-nasadenia-web-xml">Popisovač nasadenia <code>web.xml</code></h2>

<p>V ďalšom kroku by sme mali nakonfigurovať popisovač nasadenia webovej aplikácie, konkrétne súbor <code>web.xml</code>. Ten sa (v súlade s požiadavkami na webovúaplikáciu) musí nachádzať v adresári <code>WEB-INF</code>.</p>

<p>Klasické webové aplikácie založené na servletoch a JSP zvyknú v tomto súbore uviesť a nastaviť viacero servletov. Spring MVC je založený na jedinom centrálnom servlete, cez ktorý putujú všetky užívateľské požiadavky.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#579">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style="color:#070">&lt;web-app</span> <span style="color:#007">version=</span><span style="background-color:#e0e0ff">&#34;2.4&#34;</span> 
  <span style="color:#007">xmlns=</span><span style="background-color:#e0e0ff">&#34;http://java.sun.com/xml/ns/j2ee&#34;</span> 
  <span style="color:#007">xmlns:xsi=</span><span style="background-color:#e0e0ff">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> 
  <span style="color:#007">xsi:schemaLocation=</span><span style="background-color:#e0e0ff">&#34;http://java.sun.com/xml/ns/j2ee
</span><span style="background-color:#e0e0ff">                   http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&#34;</span><span style="color:#070">&gt;</span>
  
  <span style="color:#070">&lt;servlet&gt;</span>
    <span style="color:#070">&lt;servlet-name&gt;</span>springmvc<span style="color:#070">&lt;/servlet-name&gt;</span>
    <span style="color:#070">&lt;servlet-class&gt;</span>
      org.springframework.web.servlet.DispatcherServlet
    <span style="color:#070">&lt;/servlet-class&gt;</span>
    <span style="color:#070">&lt;load-on-startup&gt;</span>1<span style="color:#070">&lt;/load-on-startup&gt;</span>
  <span style="color:#070">&lt;/servlet&gt;</span>
  <span style="color:#070">&lt;servlet-mapping&gt;</span>
    <span style="color:#070">&lt;servlet-name&gt;</span>springmvc<span style="color:#070">&lt;/servlet-name&gt;</span>
    <span style="color:#070">&lt;url-pattern&gt;</span>*.do<span style="color:#070">&lt;/url-pattern&gt;</span>
  <span style="color:#070">&lt;/servlet-mapping&gt;</span>
<span style="color:#070">&lt;/web-app&gt;</span></code></pre></div>
<p>V tomto súbore sme definovali jediný servlet <code>springmvc</code> a určili, že všetky URL adresy, ktoré sa končia na <code>*.do</code> budú spracované týmto servletom.</p>

<h2 id="konfigurácia-spring-mvc">Konfigurácia Spring MVC</h2>

<p>Ďalšia konfigurácia aplikačného rámca prebieha v súbore <code>springmvc-servlet.xml</code>, ktorý sa nachádza v adresári <code>WEB-INF</code>. Názov tohto súboru je odvodený od názvu servletu (<code>springmvc</code>). Znalci Springu rýchlo zistia, že tento súbor predstavuje definíciu aplikačného kontextu.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#579">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span style="color:#070">&lt;beans</span> <span style="color:#007">xmlns=</span><span style="background-color:#e0e0ff">&#34;http://www.springframework.org/schema/beans&#34;</span>
  <span style="color:#007">xmlns:xsi=</span><span style="background-color:#e0e0ff">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
  <span style="color:#007">xmlns:context=</span><span style="background-color:#e0e0ff">&#34;http://www.springframework.org/schema/context&#34;</span>
  
  <span style="color:#007">xsi:schemaLocation=</span><span style="background-color:#e0e0ff">&#34;http://www.springframework.org/schema/beans
</span><span style="background-color:#e0e0ff">  http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
</span><span style="background-color:#e0e0ff">  http://www.springframework.org/schema/context 
</span><span style="background-color:#e0e0ff">  http://www.springframework.org/schema/context/spring-context-2.5.xsd&#34;</span><span style="color:#070">&gt;</span>
  
  <span style="color:#070">&lt;context:component-scan</span> <span style="color:#007">base-package=</span><span style="background-color:#e0e0ff">&#34;sk.spring.mvc&#34;</span> <span style="color:#070">/&gt;</span>

<span style="color:#070">&lt;/beans&gt;</span></code></pre></div>
<p>Zatiaľ uvedieme jediné nastavenie a to zapnutie automatického vyhľadávania anotovaných tried v <code>CLASSPATH</code>, presnejšie v balíčku <code>sk.spring.mvc</code>. V našom prípade to znamená, že sa v aplikačnom kontexte zaregistrujú všetky triedy z balíčka <code>sk.spring.mvc</code>, ktoré majú anotáciu <code>@Controller</code> alebo <code>@Component</code> (v skutočnosti sú podporované aj ďalšie anotácie, ale tie nás momentálne nezaujímajú). Spring sa bude o zaregistrované triedy starať, automaticky manažovať závislosti a vzťahy medzi nimi, vytvárať ich inštancie a pod. Takéto Springom manažované inštancie tried sa nazývajú <em>beany</em>.</p>

<h1 id="návrhový-vzor-mvc">Návrhový vzor MVC</h1>

<p>Spring MVC (ako už hovorí jeho názov) je založený na návrhovom vzore Model-View-Controller. Ten sa snaží oddeliť dáta z aplikačnej domény od prezentačnej vrstvy (teda užívateľského rozhrania) a od udalostí, ktoré svojou interakciou s prezentačnou vrstvou vyvoláva používateľ.</p>

<p>Parafrázujme z <a href="http://st-www.cs.uiuc.edu/users/smarch/st-docs/mvc.html">originálneho článku</a> od S. Burbecka:</p>

<ul>
<li><strong>Model</strong> manažuje dáta z aplikačnej domény, zasiela informácie o stave vrstve <em>view</em> a upravuje tieto dáta na základe akcií vyvolaných v <strong>controlleri</strong>.</li>
<li><strong>View</strong> reprezentuje používateľské rozhranie, ktoré zobrazuje dáta poskytované modelom.</li>
<li><strong>Controller</strong> spracováva používateľov vstup a podľa potreby aktualizuje model a odosiela ho do <em>view</em> vrstvy.</li>
</ul>

<p>V prípade springovskej webovej aplikácie zodpovedá týmto pojmom:</p>

<ul>
<li><strong>Modelom</strong> je ľubovoľná trieda s dátami. V našom prípade môžeme ako model používať inštancie triedy <code>Student</code>.</li>
<li><strong>Viewy</strong> budú tvorené JSP stránkami.</li>
<li><strong>Kontroléry</strong> budú triedy, ktoré spracujú HTTP požiadavku, dáta namapujú na model, vykonajú príslušné akcie a zobrazia príslušný view. Kontrolérov bude v aplikácii viac a každý z nich je jednoznačne namapovaný na danú URL adresu.</li>
</ul>

<p>Štandardná postupnosť akcií, ktorá sa vyvolá je približne nasledovná:</p>

<ol>
<li>užívateľ navštíví danú URL adresu.</li>
<li>ak užívateľ odosielal nejaké dáta (napr. z formulára), prebehne ich mapovanie na objekt modelu</li>
<li>vyvolá sa príslušná metóda kontroléra namapovaného na danú adresou</li>
<li>kontrolér aktualizuje model (ak treba) a zobrazí príslušnú JSP stránku s dátami z neho</li>
</ol>

<h1 id="zobrazenie-študenta">Zobrazenie študenta</h1>

<p>Ako prvú vec v našej webovej aplikácii vyrobíme stránku, ktorá zobrazí stále rovnakého študenta. Vyrobme si teda triedu s príslušnou metódou:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f00;background-color:#faa">public class </span>DisplayStudent {
  <span style="color:#f00;background-color:#faa">public Student </span>getStudent() {
    <span style="color:#f00;background-color:#faa">Student student </span><span style="color:#333">=</span> <span style="color:#289;font-weight:bold">new</span> Student(1L, <span style="background-color:#e0e0ff">&#34;John&#34;</span>, <span style="background-color:#e0e0ff">&#34;Doe&#34;</span>, 1, <span style="color:#289;font-weight:bold">new</span> Date(87, 4, 2)));
    <span style="color:#289;font-weight:bold">return</span> student;
  }
}</code></pre></div>
<p>Táto trieda nie je zatiaľ ničím výnimočná. Tú správnu šťavu jej dajú až anotácie, ktorými ju okoreníme.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f00;background-color:#faa">package sk</span>.<span style="color:#007">spring</span>.<span style="color:#007">mvc</span>;

<span style="color:#555;font-weight:bold">@Controller</span>
<span style="color:#f00;background-color:#faa">public class </span>DisplayStudent {

  <span style="color:#555;font-weight:bold">@RequestMapping</span>(<span style="background-color:#e0e0ff">&#34;/displayStudent.do&#34;</span>)
  <span style="color:#f00;background-color:#faa">public Student </span>getStudent() {
    <span style="color:#f00;background-color:#faa">Student student </span><span style="color:#333">=</span> <span style="color:#289;font-weight:bold">new</span> Student(1L, <span style="background-color:#e0e0ff">&#34;John&#34;</span>, <span style="background-color:#e0e0ff">&#34;Doe&#34;</span>, 1, <span style="color:#289;font-weight:bold">new</span> Date(87, 4, 2)));
    <span style="color:#289;font-weight:bold">return</span> student;
  }
}</code></pre></div>
<p>Všimnime si názov balíčka, ktorý je zhodný s deklaráciou v elemente <code>&lt;context:component-scan&gt;</code>. Ak použijeme musíme prispôsobiť názov balíčka v tejto deklarácii, v opačnom prípade Spring naše triedy nenájde.</p>

<p>Význam anotácií je nasledovný:</p>

<ul>
<li><code>@Controller</code> označuje triedu ako kontrolér, teda triedu, ktorá bude spracovávať HTTP požiadavky.</li>
<li><code>@RequestMapping</code> nad metódou <code>getStudent()</code> a jej hodnota (/<code>displayStudent.do</code>) plní trojakú úlohu:

<ol>
<li>špecifikuje URL adresu, ktorá bude zodpovedať danému kontroléru. V uvedenom príklade to znamená, že náš kontrolér bude prislúchať adrese <code>http://názovServera/názovWebovejAplikácie/displayStudent.do</code>.</li>
<li>určuje, že práve táto metóda sa má vykonať pri spracovávaní HTTP požiadavky. Kontrolér môže mať viacero verejných metód a touto anotáciou predídeme nejednoznačnostiam.</li>
<li>špecifikuje názov view, ktorý sa má zobraziť po vykonaní metódy.</li>
</ol></li>
</ul>

<p>Ak používateľ navštívi adresu končiacu sa na <code>/displayStudent.do</code>, Spring MVC prejde všetky kontroléry zaregistrované v aplikačnom kontexte a pozrie sa, ktorý z nich dokáže obslúžiť túto adresu. V našom prípade máme jediný kontrolér, <code>DisplayStudent</code>. Ďalej sa Spring MVC pozrie na metódu, ktorá sa má zavolať a to na základe anotácie <code>@RequestMapping</code>. Vykoná teda túto metódu, vezme návratovú hodnotu a použije ju pri výslednom zobrazení - inak povedané, zobrazí príslušný view.</p>

<h2 id="viewy">Viewy</h2>

<p>Ako bolo spomenuté vyššie, view zodpovedá používateľskému rozhraniu, ktoré zobrazuje dáta získané z modelu. Každý view v Spring MVC má svoje logické označenie, resp. jednoznačný identifikátor. View môže byť implementované rôznymi spôsobmi, ktoré zodpovedajú rôznym výstupným formátom. Zvyčajne je ním JSP stránka, ale k dispozícii sú aj viewy založené na PDF, DOC alebo WML súboroch.</p>

<p>Spring podporuje ľahkú výmenu implementácií viewov. To je zabezpečené mapovaním identifikátorov viewov na ich konkrétne reprezentácie.
Ukážeme si len najjednoduchší prípad, kde budeme logické označenie viewu bude zodpovedať názvu súboru JSP stránky.</p>

<p>Ak kontrolér zobrazí view <code>displayStudent</code>, zobrazíme stránku zo súboru <code>/WEB-INF/jsp/displayStudent.jsp</code>. Toto mapovanie zabezpečí bean <code>InternalResourceViewResolver</code>, ktorý deklarujeme v <code>springmvc-servlet.xml</code> dodaním elementu:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#070">&lt;bean</span> <span style="color:#007">id=</span><span style="background-color:#e0e0ff">&#34;viewResolver&#34;</span>     
      <span style="color:#f00;background-color:#faa">&lt;!--</span> <span style="color:#f00;background-color:#faa">názov</span> <span style="color:#f00;background-color:#faa">triedy</span> <span style="color:#f00;background-color:#faa">musí</span> <span style="color:#f00;background-color:#faa">byť</span> <span style="color:#f00;background-color:#faa">uvedený</span> <span style="color:#f00;background-color:#faa">spolu!</span> <span style="color:#f00;background-color:#faa">--</span><span style="color:#070">&gt;</span>
      class=&#34;org.springframework.web
             .servlet.view.InternalResourceViewResolver&#34;&gt;
  <span style="color:#070">&lt;property</span> <span style="color:#007">name=</span><span style="background-color:#e0e0ff">&#34;prefix&#34;</span> <span style="color:#007">value=</span><span style="background-color:#e0e0ff">&#34;/WEB-INF/jsp/&#34;</span><span style="color:#070">/&gt;</span>
  <span style="color:#070">&lt;property</span> <span style="color:#007">name=</span><span style="background-color:#e0e0ff">&#34;suffix&#34;</span> <span style="color:#007">value=</span><span style="background-color:#e0e0ff">&#34;.jsp&#34;</span><span style="color:#070">/&gt;</span>
<span style="color:#070">&lt;/bean&gt;</span></code></pre></div>
<p><strong>View resolver</strong> (vyhodnocovač viewov) je trieda mapujúca identifikátory viewov na konkrétne implementácie. V tomto prípade vezme názov viewu, predradí pred neho <code>/WEB-INF/jsp/</code> a zaň dodá príponu <code>.jsp</code> a výsledný súbor zobrazí klientovi. Inak povedané, pre view <code>displayStudent</code> zobrazí súbor s cestou <code>/WEB-INF/jsp/displayStudent.jsp</code>.</p>

<h2 id="ktorý-view-zobraziť">Ktorý view zobraziť?</h2>

<p>V kontroléri pre zobrazenie študenta sme ešte neurčili, ktorý view sa má zobraziť po vykonaní metódy <code>getStudent()</code>. Štandardne sa názov viewu odvodí z URL adresy nastavenej v anotácii <code>@RequestMapping</code>. Z URL adresy <code>/displayStudent.do</code> sa odsekne predpona s cestou a prípona, čo zodpovedá viewu <code>displayStudent</code>. Na základe view resolvera sa teda zobrazí JSP stránka zo súboru <code>/WEB-INF/jsp/displayStudent.jsp</code>.</p>

<h2 id="jsp-stránka">JSP stránka</h2>

<p>Ako konkrétne však má vyzerať stránka asociovaná s viewom? Založme si súbor <code>displayStudent.jsp</code> v adresári <code>WEB-INF/jsp</code> a dajme doň nasledovný obsah.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#070">h1</span>&gt;Detaily o studentovi&lt;/<span style="color:#070">h1</span>&gt;
&lt;<span style="color:#070">b</span>&gt;ID:&lt;/<span style="color:#070">b</span>&gt; ${student.id} &lt;<span style="color:#070">br</span> /&gt;
&lt;<span style="color:#070">b</span>&gt;Meno:&lt;/<span style="color:#070">b</span>&gt; ${student.firstName} &lt;<span style="color:#070">br</span> /&gt;
&lt;<span style="color:#070">b</span>&gt;Priezvisko:&lt;/<span style="color:#070">b</span>&gt; ${student.lastName} &lt;<span style="color:#070">br</span> /&gt;
&lt;<span style="color:#070">b</span>&gt;Rocnik:&lt;/<span style="color:#070">b</span>&gt; ${student.year} &lt;<span style="color:#070">br</span> /&gt;</code></pre></div>
<p>Táto stránka obsahuje zvyčajný HTML kód (aj keď, napísaný viac než šlendriánsky) a niekoľko <em>premenných</em>, ktoré sa začínajú dolárom a ich názov je v kučeravých zátvorkách. Na tieto premenné sa naviažu hodnoty získané z kontroléra.</p>

<p>V rámci premenných môžeme používať bodkovú notáciu. Ak v premennej <code>student</code> je objekt typu <code>Student</code>, notácia <code>student.firstName</code> je ekvivalentná zavolaniu metódy <code>getFirstName()</code> na objekte študenta.</p>

<h2 id="dodanie-hodnôt-z-kontroléra-do-viewu">Dodanie hodnôt z kontroléra do viewu</h2>

<p>Kontrolér odovzdá stránke model, čo je, voľne povedané, mapovanie reťazcov (názvov premenných) na objekty (hodnoty premenných). Po zavolaní metódy <code>getStudent()</code> sa Spring MVC automaticky pozrie na návratový typ metódy. Keďže metóda vracia objekt typu <code>Student</code>, vytvorí sa premenná <code>student</code> (jej názov sa odvodí od názvu triedy, pričom prvé písmeno bude malé), ktorej hodnotou bude vrátený objekt.</p>

<p>Model bude vyzerať približne takto</p>

<pre><code>model
  |&quot;student&quot; =&gt; sk.upjs.students.Student@23242ae
</code></pre>

<p>Tým sme teda dokončili náš prvý kontrolér spolu s príslušným view. Aplikácia je pripravená na nasadenie do servletového kontajnera. Spustíme ju a navštívime príslušnú adresu (končiacu sa na <code>/displayStudent.do</code>). Mali by sme vidieť zobrazené detaily o našom študentovi.</p>

<h1 id="zobrazenie-študenta-s-použitím-databázy">Zobrazenie študenta s použitím databázy</h1>

<p>V ďalšom kroku si upravíme kontrolér tak, aby umožňoval zobrazenie študenta na základe užívateľom dodaného identifikátora. Ešte predtým si však vytvorme triedu, ktorá bude simulovať relačnú databázu, v ktorej budú uložení študenti.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@Component</span>
<span style="color:#f00;background-color:#faa">public class </span>Database {
  <span style="color:#f00;background-color:#faa">private List</span><span style="color:#333">&lt;</span><span style="color:#f00;background-color:#faa">Student&gt; students </span><span style="color:#333">=</span> <span style="color:#289;font-weight:bold">new</span> ArrayList<span style="color:#333">&lt;</span>Student<span style="color:#333">&gt;</span>();
  
  <span style="color:#f00;background-color:#faa">public Database</span>() {
    students.<span style="color:#007">add</span>(
      <span style="color:#289;font-weight:bold">new</span> Student(1L, <span style="background-color:#e0e0ff">&#34;John&#34;</span>, <span style="background-color:#e0e0ff">&#34;Doe&#34;</span>, 1, <span style="color:#289;font-weight:bold">new</span> Date(87, 4, 2)));
    students.<span style="color:#007">add</span>(
      <span style="color:#289;font-weight:bold">new</span> Student(2L, <span style="background-color:#e0e0ff">&#34;Michael&#34;</span>, <span style="background-color:#e0e0ff">&#34;Jackson&#34;</span>, 1, <span style="color:#289;font-weight:bold">new</span> Date(86, 1, 2)));
    students.<span style="color:#007">add</span>(
      <span style="color:#289;font-weight:bold">new</span> Student(3L, <span style="background-color:#e0e0ff">&#34;Jane&#34;</span>, <span style="background-color:#e0e0ff">&#34;Greengroces&#34;</span>, 2, <span style="color:#289;font-weight:bold">new</span> Date(83, 4, 3)));
    students.<span style="color:#007">add</span>(
      <span style="color:#289;font-weight:bold">new</span> Student(4L, <span style="background-color:#e0e0ff">&#34;Arthur&#34;</span>, <span style="background-color:#e0e0ff">&#34;Pewtey&#34;</span>, 4, <span style="color:#289;font-weight:bold">new</span> Date(84, 12, 12)));
    students.<span style="color:#007">add</span>(
      <span style="color:#289;font-weight:bold">new</span> Student(5L, <span style="background-color:#e0e0ff">&#34;Sidney&#34;</span>, <span style="background-color:#e0e0ff">&#34;Pollack&#34;</span>, 3, <span style="color:#289;font-weight:bold">new</span> Date(78, 10, 4)));
    students.<span style="color:#007">add</span>(
      <span style="color:#289;font-weight:bold">new</span> Student(6L, <span style="background-color:#e0e0ff">&#34;Andrew&#34;</span>, <span style="background-color:#e0e0ff">&#34;Mordon&#34;</span>, 5, <span style="color:#289;font-weight:bold">new</span> Date(12, 5, 8)));   
  }
  
  <span style="color:#666;font-style:italic">/**
</span><span style="color:#666;font-style:italic">   * Vráti zoznam všetkých študentov v databáze. Zoznam
</span><span style="color:#666;font-style:italic">   * je nemeniteľný.
</span><span style="color:#666;font-style:italic">   */</span>
  <span style="color:#f00;background-color:#faa">public List</span><span style="color:#333">&lt;</span><span style="color:#f00;background-color:#faa">Student&gt; listStudents</span>() {
    <span style="color:#289;font-weight:bold">return</span> Collections.<span style="color:#007">unmodifiableList</span>(students);
  }
  
  <span style="color:#666;font-style:italic">/**
</span><span style="color:#666;font-style:italic">   * Nájde v databáze študenta s daným identifikátorom. Ak
</span><span style="color:#666;font-style:italic">   * sa taký študent nenájde, vráti &lt;code&gt;null&lt;/code&gt;.
</span><span style="color:#666;font-style:italic">   */</span>
  <span style="color:#f00;background-color:#faa">public Student </span>findById(<span style="color:#f00;background-color:#faa">Long id</span>) {
    <span style="color:#289;font-weight:bold">for</span> (<span style="color:#f00;background-color:#faa">Student student </span><span style="color:#333">:</span> students) {
      <span style="color:#289;font-weight:bold">if</span>(student.<span style="color:#007">getId</span>().<span style="color:#007">equals</span>(id)) {
        <span style="color:#289;font-weight:bold">return</span> student;
      }
    }
    <span style="color:#289;font-weight:bold">return</span> <span style="color:#289;font-weight:bold">null</span>;
  }
  
  <span style="color:#666;font-style:italic">/**
</span><span style="color:#666;font-style:italic">   * Uloží alebo aktualizuje objekt študenta. Ak má študent
</span><span style="color:#666;font-style:italic">   * identifikátor rovný &lt;code&gt;null&lt;/code&gt;, znamená
</span><span style="color:#666;font-style:italic">   * to inštanciu, ktorá v databáze ešte nie je. V opačnom 
</span><span style="color:#666;font-style:italic">   * prípade sa existujúca inštancia s takým ID nahradí
</span><span style="color:#666;font-style:italic">   * novou inštanciou s aktualizovanými dátami. 
</span><span style="color:#666;font-style:italic">   * 
</span><span style="color:#666;font-style:italic">   * @param student
</span><span style="color:#666;font-style:italic">   */</span>
  <span style="color:#f00;background-color:#faa">public void </span>saveOrUpdate(<span style="color:#f00;background-color:#faa">Student student</span>) {
    <span style="color:#289;font-weight:bold">if</span>(student.<span style="color:#007">getId</span>() <span style="color:#333">==</span> <span style="color:#289;font-weight:bold">null</span>) {
      student.<span style="color:#007">setId</span>(<span style="color:#289;font-weight:bold">new</span> Date().<span style="color:#007">getTime</span>());
      students.<span style="color:#007">add</span>(student);
      <span style="color:#289;font-weight:bold">return</span>;
    }
    <span style="color:#f00;background-color:#faa">Student dbStudent </span><span style="color:#333">=</span> findById(student.<span style="color:#007">getId</span>());
    students.<span style="color:#007">remove</span>(dbStudent);
    students.<span style="color:#007">add</span>(student);
  }
  
  <span style="color:#666;font-style:italic">/**
</span><span style="color:#666;font-style:italic">   * Odstráni z databázy študenta s daným identifikátorom.
</span><span style="color:#666;font-style:italic">   * Inštancia v parametri nemusí mať vyplnené všetky údaje, stačí,
</span><span style="color:#666;font-style:italic">   * keď má vyplnený identifikátor.
</span><span style="color:#666;font-style:italic">   */</span> 
  <span style="color:#f00;background-color:#faa">public void </span>removeStudent(<span style="color:#f00;background-color:#faa">Student student</span>) {
    <span style="color:#f00;background-color:#faa">Student dbStudent </span><span style="color:#333">=</span> findById(student.<span style="color:#007">getId</span>());
    <span style="color:#289;font-weight:bold">if</span>(dbStudent <span style="color:#333">!=</span> <span style="color:#289;font-weight:bold">null</span>) {
      students.<span style="color:#007">remove</span>(dbStudent);
    }
  }
}</code></pre></div>
<p>Všimnime si, že trieda má anotáciu <code>@Component</code>, čo zaručí jej automatickú registráciu v aplikačnom kontexte Springu. Triedy, ktoré budú potrebovať prístup k databáze, sa na ňu budú môcť odkazovať pomocou špeciálnej anotácie, ktorú si ukážeme o niečo nižšie.</p>

<p>Upravme si teraz kontrolér tak, aby jeho metóda mala medzi parametrami identifikátor a vracala príslušného študenta.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@Controller</span>
<span style="color:#f00;background-color:#faa">public class </span>DisplayStudent {
  <span style="color:#555;font-weight:bold">@Autowired</span>
  <span style="color:#f00;background-color:#faa">private Database </span>database;

  <span style="color:#555;font-weight:bold">@RequestMapping</span>(<span style="background-color:#e0e0ff">&#34;/displayStudent.do&#34;</span>)
  <span style="color:#f00;background-color:#faa">public Student </span>getStudent(<span style="color:#f00;background-color:#faa">Long id</span>) {
    <span style="color:#289;font-weight:bold">return</span> database.<span style="color:#007">findById</span>(id);
  }
}</code></pre></div>
<p>Vykonali sme dve zmeny: pridali sme inštančnú premennú <code>database</code> s anotáciou <code>@Autowired</code>. To naznačí Springu, že do nej má vložiť inštanciu beanu pre databázu, ktorá sa nachádza v aplikačnom kontexte. (Taká inštancia existuje, keďže trieda <code>Database</code> bola anotovaná ako komponent). Okrem toho sme do metódy <code>getStudent()</code> dodali parameter s identifikátorom.</p>

<p>Je známe, že URL adresy môžu v sebe obsahovať parametre dopytu. Príkladom môže byť adresa <code>http://localhost:8080/students/displayStudent.do?id=2&amp;displayAll=true</code>. Za otáznikom nasledujú dvojice <em>názov parametra</em>=<em>hodnota parametra</em> oddelené ampersandom. V našom prípade máme dva parametre: <em>id</em>=<em>2</em> a <em>displayAll</em> = <em>true</em>. Spring MVC vie namapovať tieto parametre z URL adresy na parametre metódy. Parameter <em>id</em> sa namapuje na parameter <code>Long id</code>. Keďže parametre v URL adrese sú len reťazcové, je potrebné previesť konverziu hodnôt. Spring MVC však tieto prevody rieši automaticky.</p>

<p>Inými slovami, po navštívení adresy <code>http://localhost:8080/students/displayStudent.do?id=2&amp;displayAll=true</code> sa v rámci metódy <code>getStudent()</code> vloží do parametra <code>id</code> hodnota 2. Parameter <code>displayAll</code> sa nedá namapovať na žiadny parameter metódy a preto sa ignoruje.</p>

<p>Parametre metódy, ktoré nemajú svoj protipól v URL adrese, budú nastavené na <code>null</code>. Adresa <code>http://localhost:8080/students/displayStudent.do</code> teda vloží do parametra <code>Long id</code> hodnotu <code>null</code>.</p>

<h1 id="zobrazenie-zoznamu-študentov">Zobrazenie zoznamu študentov</h1>

<p>Ďalším príkladom v našej webovej aplikácii bude stránka, ktorá zobrazí zoznam študentov v databáze v prehľadnej tabuľke. Na to budeme opäť potrebovať:</p>

<ol>
<li>JSP stránku</li>
<li>triedu kontroléra</li>
</ol>

<h2 id="jsp-stránka-1">JSP stránka</h2>

<p>V adresári <code>WEB-INF/jsp</code> vytvorme stránku <code>listStudents.jsp</code> s nasledovným obsahom:</p>

<pre><code>&lt;%@ taglib prefix=&quot;c&quot; 
           uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;
&lt;table&gt;
  &lt;tr&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Surname&lt;/th&gt;&lt;th&gt;Year&lt;/th&gt;

  &lt;c:forEach items=&quot;${studentList}&quot; var=&quot;student&quot;&gt;
    &lt;tr&gt;
      &lt;td&gt;${student.firstName}&lt;/td&gt;
      &lt;td&gt;${student.lastName}&lt;/td&gt;
      &lt;td&gt;${student.year}&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/c:forEach&gt;
&lt;/table&gt;
</code></pre>

<p>V JSP stránke používame špeciálnu značku špecifikácie JSTL: <code>&lt;c:foreach&gt;</code> vie iterovať cez zoznam alebo pole obsiahnutom v premennej <code>${studentList}</code>. Každý prvok vloží do premennej <code>${student}</code>, ku ktorej môžeme pristupovať v rámci iterácie.</p>

<h2 id="kontrolér">Kontrolér</h2>

<p>Kontrolér sa nebude líšiť od toho predošlého - rozdielom bude návratová hodnota.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@Controller</span>
<span style="color:#f00;background-color:#faa">public class </span>ListStudents {
  <span style="color:#555;font-weight:bold">@Autowired</span>
  <span style="color:#f00;background-color:#faa">private Database </span>database;
  
  <span style="color:#555;font-weight:bold">@RequestMapping</span>(<span style="background-color:#e0e0ff">&#34;/listStudents.do&#34;</span>)
  <span style="color:#f00;background-color:#faa">public List</span><span style="color:#333">&lt;</span><span style="color:#f00;background-color:#faa">Student&gt; listStudents</span>() {
    <span style="color:#f00;background-color:#faa">List&lt;Student&gt; students </span><span style="color:#333">=</span> database.<span style="color:#007">listStudents</span>();
    <span style="color:#289;font-weight:bold">return</span> students;
  }
}</code></pre></div>
<p>V tomto prípade vracia metóda zoznam študentov <code>List&lt;Student&gt;</code>. Do mapovania premenných stránky sa vloží premenná <code>studentList</code> (predpona sa odvodí z dátového typu zoznamu, prípona <code>list</code> zodpovedá kolekcii) s výsledným zoznamom.</p>

<h1 id="vytvorenie-študenta">Vytvorenie študenta</h1>

<h2 id="jsp-stránka-2">JSP stránka</h2>

<p>V ďalšom kroku si vytvoríme stránku, pomocou ktorej vieme vytvoriť nového študenta a uložiť ho do databázy. Opäť budeme potrebovať triedu kontroléra a JSP, ktorá bude oproti predošlému príkladu zložitejšia - bude obsahovať HTML formulár.</p>

<p>Založíme súbor <code>createStudent.jsp</code> v adresári <code>WEB-INF/jsp</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f00;background-color:#faa">&lt;</span>%@ taglib prefix=&#34;c&#34; 
           uri=&#34;http://java.sun.com/jsp/jstl/core&#34; %&gt;
<span style="color:#f00;background-color:#faa">&lt;</span>%@ taglib prefix=&#34;form&#34; 
           uri=&#34;http://www.springframework.org/tags/form&#34; %&gt;

<span style="color:#070">&lt;h1&gt;</span>Upraviť študenta<span style="color:#070">&lt;/h1&gt;</span>

<span style="color:#070">&lt;form:form</span> <span style="color:#007">commandName=</span><span style="background-color:#e0e0ff">&#34;student&#34;</span><span style="color:#070">&gt;</span>
  <span style="color:#070">&lt;table&gt;</span>
    <span style="color:#070">&lt;tr&gt;</span>
      <span style="color:#070">&lt;th&gt;</span>Meno:<span style="color:#070">&lt;/th&gt;</span>
      <span style="color:#070">&lt;td&gt;&lt;form:input</span> <span style="color:#007">path=</span><span style="background-color:#e0e0ff">&#34;firstName&#34;</span><span style="color:#070">/&gt;&lt;/td&gt;</span>
    <span style="color:#070">&lt;/tr&gt;</span>
    <span style="color:#070">&lt;tr&gt;</span>
      <span style="color:#070">&lt;th&gt;</span>Priezvisko:<span style="color:#070">&lt;/th&gt;</span>
      <span style="color:#070">&lt;td&gt;&lt;form:input</span> <span style="color:#007">path=</span><span style="background-color:#e0e0ff">&#34;lastName&#34;</span><span style="color:#070">/&gt;&lt;/td&gt;</span>
    <span style="color:#070">&lt;/tr&gt;</span>
    <span style="color:#070">&lt;tr&gt;</span>
      <span style="color:#070">&lt;th&gt;</span>Ročník:<span style="color:#070">&lt;/th&gt;</span>
      <span style="color:#070">&lt;td&gt;&lt;form:input</span> <span style="color:#007">path=</span><span style="background-color:#e0e0ff">&#34;year&#34;</span><span style="color:#070">/&gt;&lt;/td&gt;</span>
    <span style="color:#070">&lt;/tr&gt;</span>
    <span style="color:#070">&lt;tr&gt;</span>
      <span style="color:#070">&lt;td</span> <span style="color:#007">colspan=</span><span style="background-color:#e0e0ff">&#34;2&#34;</span><span style="color:#070">&gt;</span> <span style="color:#070">&lt;input</span> <span style="color:#007">type=</span><span style="background-color:#e0e0ff">&#34;submit&#34;</span> <span style="color:#070">/&gt;</span> <span style="color:#070">&lt;/td&gt;</span>
    <span style="color:#070">&lt;/tr&gt;</span>
  <span style="color:#070">&lt;/table&gt;</span>
<span style="color:#070">&lt;/form:form&gt;</span></code></pre></div>
<p>Na rozdiel od predošlej stránky tu používame špeciálnu sadu tagov poskytovaných Springom. Túto sadu sme zaviedli v hlavičke stránky deklaráciou</p>

<pre><code>&lt;%@ taglib prefix=&quot;form&quot; 
           uri=&quot;http://www.springframework.org/tags/form&quot; %&gt;
</code></pre>

<p>Tag <code>&lt;form:form&gt;</code> zodpovedá HTML tagu <code>&lt;form&gt;</code>. Poskytuje však podporu pre automatické mapovanie hodnôt z modelu na ovládacie prvky. Premenná, v ktorej sa model nachádza, je nastavená v atribúte <code>commandName</code>.
Ostatné tagy <code>&lt;form:input&gt;</code> zodpovedajú tagom <code>&lt;input&gt;</code> z HTML. Majú však špeciálny atribút <code>path</code>, ktorý špecifikuje názov inštančnej premennej, na ktorú sa má hodnota prvku namapovať.
V našom prípade je modelový objekt uložený v premennej <code>student</code>. Ak je v nej objekt typu <code>Student</code>, potom ovládací prvok s <code>path=&quot;firstName&quot;</code> bude získavať hodnotu z metódy <code>getFirstName()</code> a po odoslaní formulára sa na modelovom objekte zavolá <code>setFirstName()</code>, kde v parametri bude hodnota z tohto ovládacieho prvku.</p>

<h2 id="kontrolér-1">Kontrolér</h2>

<p>Postup činností, ktoré sa vykonávajú pri práci s týmto kontrolérom pozostáva z dvoch fáz:</p>

<ol>
<li>v prvej fáze sa zobrazí view s formulárom - teda prázdny formulár (metódou HTTP GET). Používateľ ho vyplní a odošle.</li>
<li>v druhej fáze sa prevezmú odoslané dáta (metódou POST), namapujú na modelový objekt, spracujú a zobrazí sa výsledný view.</li>
</ol>

<p>Vytvorme teraz prvú verziu triedy kontroléra:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@Controller</span>
<span style="color:#555;font-weight:bold">@RequestMapping</span>(<span style="background-color:#e0e0ff">&#34;/createStudent.do&#34;</span>)
<span style="color:#f00;background-color:#faa">public class </span>CreateStudent {
 
  <span style="color:#555;font-weight:bold">@RequestMapping</span>(method <span style="color:#333">=</span> RequestMethod.<span style="color:#007">GET</span>)
  <span style="color:#f00;background-color:#faa">public Student </span>displayStudent() {
    <span style="color:#f00;background-color:#faa">Student student </span><span style="color:#333">=</span> <span style="color:#289;font-weight:bold">new</span> Student();
    <span style="color:#289;font-weight:bold">return</span> student;
  }
}</code></pre></div>
<p>Anotáciu <code>@RequestMapping</code> teraz odsunieme nad triedu. Vytvoríme metódu <code>displayStudent()</code>, ktorú anotujeme samostatným <code>@RequestMapping</code>om indikujúcim, že táto metóda sa má vykonať pri GET požiadavke. V nej vytvoríme prázdneho študenta, ktorý bude slúžiť ako modelový objekt. Dôvodom je to, že potrebujeme pre prázdny formulár potrebujeme nejaký modelový objekt. Prázdny študent s nevyplnenými dátami bude tým objektom, ktorý sa vo formulári vyplní. Metóda vracia mapovanie, kde sa premennej <code>&quot;student&quot;</code> priradí inštancia prázdneho študenta. Po jej vykonaní sa zobrazí view <code>createStudent</code>, kde sa vo formulári pracuje nad daným študentom.</p>

<p>Teraz dodajme metódu, ktorá bude spracovávať odoslané dáta.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@Autowired</span>
<span style="color:#f00;background-color:#faa">private Database </span>database;

<span style="color:#555;font-weight:bold">@RequestMapping</span>(method <span style="color:#333">=</span> RequestMethod.<span style="color:#007">POST</span>)
<span style="color:#f00;background-color:#faa">public String </span>updateStudent(<span style="color:#f00;background-color:#faa">Student student</span>) {
  database.<span style="color:#007">saveOrUpdate</span>(student);
  <span style="color:#289;font-weight:bold">return</span> <span style="background-color:#e0e0ff">&#34;redirect:listStudents.do&#34;</span>;
}  </code></pre></div>
<p>Metóda <code>updateStudent()</code> sa zavolá pri odoslaní formulára, teda pri požiadavke POST (viď anotácia). Má jeden parameter typu <code>Student</code>, na ktorý sa namapujú dáta z formulára (na základe atribútu <code>path</code> v ovládacích prvkoch formulára). Objekt typu <code>Student</code> len uložíme do databázy a zobrazíme nový view.</p>

<p>V tomto prípade budeme chcieť po odoslaní formulára zobraziť zoznam študentov, teda stránku na adrese <code>/listStudents.do</code>. V metódach kontroléra, ktoré sú anotované pomocou <code>@RequestMapping</code> platí, že ak je návratovou hodnotou reťazec, tak ten sa zinterpretuje ako názov viewu, ktorý sa má zobraziť.</p>

<p>View so špeciálnym názvom <code>redirect:listStudents.do</code> presmeruje používateľa na adresu končiacu sa na <code>listStudents.do</code>. Na takúto adresu už máme namapovaný predošlý kontrolér <code>ListStudents</code>, na ktorom sa automaticky zavolá príslušná metóda a zobrazí sa nový zoznam (aj s čerstvo pridaným študentom).</p>

<h3 id="validácia">Validácia</h3>

<p>Náš kontrolér má jednu chybu - uloží aj študenta, ktorý nemá žiadne vyplnené údaje, čo zrejme nie je ideálny prípad. Validácia by mala zaistiť kontrolu korektnosti a konzistencie dát a v prípade nesúladu na ne používateľa upozorniť.</p>

<p>V Spring MVC existuje užitočný interfejs <code>Validator</code>, ktoré reprezentuje triedu schopnú zvalidovať daný objekt. Vytvorme si triedu <code>StudentValidator</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f00;background-color:#faa">public class StudentValidator implements </span>Validator {
  <span style="color:#f00;background-color:#faa">public void </span>validate(<span style="color:#f00;background-color:#faa">Object target</span>, <span style="color:#f00;background-color:#faa">Errors errors</span>) {
    <span style="color:#f00;background-color:#faa">Student student </span><span style="color:#333">=</span> (Student) target;
    ValidationUtils.<span style="color:#007">rejectIfEmptyOrWhitespace</span>(
      errors, <span style="background-color:#e0e0ff">&#34;firstName&#34;</span>, <span style="background-color:#e0e0ff">&#34;&#34;</span>, <span style="background-color:#e0e0ff">&#34;Name cannot be empty.&#34;</span>);
    ValidationUtils.<span style="color:#007">rejectIfEmptyOrWhitespace</span>(
      errors, <span style="background-color:#e0e0ff">&#34;lastName&#34;</span>, <span style="background-color:#e0e0ff">&#34;&#34;</span>, <span style="background-color:#e0e0ff">&#34;Last name cannot be empty.&#34;</span>);
    <span style="color:#289;font-weight:bold">if</span>(student.<span style="color:#007">getYear</span>() <span style="color:#333">&lt;</span> 1 <span style="color:#333">||</span> student.<span style="color:#007">getYear</span>() <span style="color:#333">&gt;</span> 5) {
      errors.<span style="color:#007">rejectValue</span>(<span style="background-color:#e0e0ff">&#34;year&#34;</span>, <span style="background-color:#e0e0ff">&#34;&#34;</span>, 
                         <span style="background-color:#e0e0ff">&#34;Year must be between 1 and 5!&#34;</span>);
    }
  }
  
  <span style="color:#f00;background-color:#faa">public boolean </span>supports(<span style="color:#f00;background-color:#faa">Class clazz</span>) {
    <span style="color:#289;font-weight:bold">return</span> Student.<span style="color:#007">class</span>.<span style="color:#007">isAssignableFrom</span>(clazz);
  }  
}</code></pre></div>
<p>V metóde <code>supports()</code> určíme aké dátové typy vie validátor spracovať - je zrejmé, že <code>Student</code>ov. Filozofia metódy <code>validate()</code> je nasledovná: v <code>target</code> máme objekt, ktorý chceme zvalidovať a <code>errors</code> predstavuje objekt, do ktorého pridávame chybové hlášky. V ukážke máme dva prístupy k validácii:</p>

<ul>
<li><code>ValidationUtils.rejectIfEmptyOrWhitespace()</code> skontroluje neprázdnosť danej inštančnej premennej.</li>
<li><code>errors.rejectValue()</code> umožňuje zamietnuť inštančnú premennú v prípade, že je kontrola zložitejšia kontrola.</li>
</ul>

<p>Validátor potom pridáme do kontroléra jednoducho: napr. ako inštančnú premennú:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f00;background-color:#faa">private static StudentValidator studentValidator 
</span><span style="color:#f00;background-color:#faa">  </span><span style="color:#333">=</span> <span style="color:#289;font-weight:bold">new</span> StudentValidator();</code></pre></div>
<p>Jeho použitie bude nasledovné - upravíme si metódu volanú pri POST požiadavke:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@RequestMapping</span>(method <span style="color:#333">=</span> RequestMethod.<span style="color:#007">POST</span>)
<span style="color:#f00;background-color:#faa">public String </span>updateStudent(<span style="color:#f00;background-color:#faa">Student student</span>, <span style="color:#f00;background-color:#faa">Errors errors</span>) {
  studentValidator.<span style="color:#007">validate</span>(student, errors);
  <span style="color:#289;font-weight:bold">if</span>(errors.<span style="color:#007">hasErrors</span>()) {
    <span style="color:#289;font-weight:bold">return</span> <span style="background-color:#e0e0ff">&#34;createStudent&#34;</span>;
  }
  database.<span style="color:#007">saveOrUpdate</span>(student);

  <span style="color:#289;font-weight:bold">return</span> <span style="background-color:#e0e0ff">&#34;redirect:listStudents.do&#34;</span>;
}</code></pre></div>
<p>Do metódy <code>updateStudent()</code> sme dodali nový parameter typu <code>Errors</code>, do ktorého môžeme vkladať chybové hlášky. Modelový objekt zvalidujeme a v prípade, že nastala nejaká chyba zobrazíme pôvodnú stránku (teda view <code>createStudent</code>). V prípade úspešnej validácie objekt uložíme a zobrazíme zoznam študentov.</p>

<p>Náš kontrolér je nedokonalý - v prípade, že validácia neprejde, sa používateľovi zobrazí pôvodný formulár bez akejkoľvek chybovej hlášky či upozornenia. Tie je možné zobraziť pomocou tagu <code>&lt;form:errors&gt;</code>, ktorý dodáme do formulára:</p>

<pre><code>...
&lt;form:form commandName=&quot;student&quot;&gt;
  &lt;form:errors path=&quot;*&quot; /&gt;
  ...
&lt;/form:form&gt;
</code></pre>

<p>Hviezdička v atribúte <code>path</code> hovorí, že sa majú zobraziť všetky validačné chyby týkajúce sa všetkých inštančných premenných modelového objektu. Ak chceme zobraziť len chyby týkajúce sa ovládacieho prvku pre zadanie mena, môžeme vyšpecifikovať <code>path=&quot;firstName&quot;</code>. Tagov <code>&lt;form:errors&gt;</code> môže byť v rámci formulára aj viac.</p>

<h1 id="úprava-študenta">Úprava študenta</h1>

<p>Prejdime teraz k ďalšiemu kroku - k stránke pomocou ktorej môžeme upraviť dáta existujúceho študenta.</p>

<h2 id="jsp-stránka-3">JSP stránka</h2>

<p>JSP stránku nemusíme vyrábať - môžeme totiž použiť stránku <code>createStudent.jsp</code>.</p>

<h2 id="kontrolér-2">Kontrolér</h2>

<p>Kontrolér <code>EditStudent</code> anotovaný ako <code>@RequestMapping(&quot;/editStudent.do&quot;)</code> bude veľmi podobný kontroléru pre vytvorenie študenta. Jedinou odlišnosťou bude kód v metóde <code>displayStudent()</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@RequestMapping</span>(method <span style="color:#333">=</span> RequestMethod.<span style="color:#007">GET</span>)
<span style="color:#f00;background-color:#faa">public String </span>displayStudent(<span style="color:#f00;background-color:#faa">Long studentId</span>, <span style="color:#f00;background-color:#faa">ModelMap model</span>) {
  <span style="color:#f00;background-color:#faa">Student student </span><span style="color:#333">=</span> database.<span style="color:#007">findById</span>(studentId);
  <span style="color:#289;font-weight:bold">if</span>(student <span style="color:#333">==</span> <span style="color:#289;font-weight:bold">null</span>) {
    <span style="color:#289;font-weight:bold">throw</span> <span style="color:#289;font-weight:bold">new</span> IllegalArgumentException();
  } 
  model.<span style="color:#007">addAttribute</span>(student);

  <span style="color:#289;font-weight:bold">return</span> <span style="background-color:#e0e0ff">&#34;createStudent&#34;</span>;
}</code></pre></div>
<p>V tomto prípade je situácia o niečo odlišnejšia. Dosiaľ sme totiž vracali view odvodený od URL adresy. V tomto prípade však potrebujeme zobraziť view <code>createStudent</code> a navyše doň chceme odovzdať model obsahujúci objekt študenta. Ako na to? Do metódy sme dodali nový parameter - modelovú mapu. To je presne mapa, do ktorej môžeme pridávať názvy premenných a ich hodnoty. Údaje v tejto mape zodpovedajú modelu, ktorý sa použije pri zobrazovaní stránky. Metóda <code>addAttribute(student)</code> pridá do modelovej mapy premennú student` (odvodenú od názvu triedy) s hodnotou zodpovedajúcemu objektu v parametri.</p>

<p>Metóda <code>displayStudent()</code> vracia reťazec, ktorý sa interpretuje ako názov viewu, ktorý sa má zobraziť. Súhrnne sa po zavolaní metódy zobrazí view <code>createStudent</code>, pričom dáta doň sa prevezmú z modelovej mapy <code>model</code>.</p>

<h2 id="ošetrovanie-výnimiek">Ošetrovanie výnimiek</h2>

<p>Metóda <code>displayStudent()</code> vyhodí v prípade, že sa snažíme nájsť študenta s neexistujúcim identifikátorom, výnimku <code>IllegalArgumentException</code>. Užívateľ sa asi takejto chybovej hláške neveľmi poteší (taký <em>stack trace</em> nie je veľmi príjemné čítanie). Namiesto toho je lepšie zobraziť nejakú prítulnejšiu stránku s rozumným popisom.</p>

<p>Vytvorme stránku <code>unknownEntity.jsp</code> v adresári <code>WEB-INF/jsp</code>, do ktorej uveďme nejaký prívetivý oznam o tom, že požadovaný objekt sa nenašiel.</p>

<p>Následne môžeme zadefinovať mapovanie medzi výnimkami a viewmi, ktoré sa majú zobraziť. V našom prípade môžeme namapovať výnimku <code>IllegalArgumentException</code> na view <code>unknownEntity</code>. Do súboru <code>springmvc-servlet.xml</code> dodáme deklaráciu beanu:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#070">&lt;bean</span> <span style="color:#007">id=</span><span style="background-color:#e0e0ff">&#34;exceptionHandler&#34;</span> 
      <span style="color:#f00;background-color:#faa">&lt;!--</span> <span style="color:#f00;background-color:#faa">názov</span> <span style="color:#f00;background-color:#faa">triedy</span> <span style="color:#f00;background-color:#faa">bol</span> <span style="color:#f00;background-color:#faa">zalomený</span> <span style="color:#f00;background-color:#faa">--</span><span style="color:#070">&gt;</span>
      class=&#34;org.springframework.
             web.servlet.handler.SimpleMappingExceptionResolver&#34;&gt;
  <span style="color:#070">&lt;property</span> <span style="color:#007">name=</span><span style="background-color:#e0e0ff">&#34;exceptionMappings&#34;</span><span style="color:#070">&gt;</span>
    <span style="color:#070">&lt;props&gt;</span>
      <span style="color:#070">&lt;prop</span> <span style="color:#007">key=</span><span style="background-color:#e0e0ff">&#34;IllegalArgumentException&#34;</span><span style="color:#070">&gt;</span>unknownEntity<span style="color:#070">&lt;/prop&gt;</span>
    <span style="color:#070">&lt;/props&gt;</span>
  <span style="color:#070">&lt;/property&gt;</span>
<span style="color:#070">&lt;/bean&gt;</span></code></pre></div>
<p>Ak ľubovoľný z kontrolérov vyhodí výnimku <code>IllegalArgumentException</code>, zobrazí sa view <code>unknownEntity</code>.</p>

<h1 id="ďalšie-ovládacie-prvky">Ďalšie ovládacie prvky</h1>

<p>Upravme si formulár pre editáciu študenta tak, aby používateľ nemusel zadávať ročník ako číslo do textového políčka, ale aby si ho pohodlne vybral z rozbaľovacieho zoznamu. V príslušnej JSP stránke môžeme nahradiť:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#070">form:input</span> <span style="color:#007">path</span><span style="color:#333">=</span><span style="background-color:#e0e0ff">&#34;year&#34;</span>/&gt;</code></pre></div>
<p>špeciálnou značkou, ktorá automaticky vygeneruje rozbaľovací zoznam:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#070">form:select</span> <span style="color:#007">path</span><span style="color:#333">=</span><span style="background-color:#e0e0ff">&#34;year&#34;</span> <span style="color:#007">items</span><span style="color:#333">=</span><span style="background-color:#e0e0ff">&#34;${allYears}&#34;</span>/&gt;</code></pre></div>
<p>Položky v zozname sa naplnia z premennej <code>allYears</code>, ktorú prirodzene musíme naplniť v kontroléri.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@ModelAttribute</span>(<span style="background-color:#e0e0ff">&#34;allYears&#34;</span>)
<span style="color:#f00;background-color:#faa">public Map</span><span style="color:#333">&lt;</span>Integer, <span style="color:#f00;background-color:#faa">String&gt; getAllYears</span>() {
  Map<span style="color:#333">&lt;</span>Integer, <span style="color:#f00;background-color:#faa">String&gt; hodnoty </span><span style="color:#333">=</span> <span style="color:#289;font-weight:bold">new</span> TreeMap<span style="color:#333">&lt;</span>Integer, String<span style="color:#333">&gt;</span>();
  hodnoty.<span style="color:#007">put</span>(1, <span style="background-color:#e0e0ff">&#34;prvák&#34;</span>);
  hodnoty.<span style="color:#007">put</span>(2, <span style="background-color:#e0e0ff">&#34;druhák&#34;</span>);
  hodnoty.<span style="color:#007">put</span>(3, <span style="background-color:#e0e0ff">&#34;tretiak&#34;</span>);
  hodnoty.<span style="color:#007">put</span>(4, <span style="background-color:#e0e0ff">&#34;štvrták&#34;</span>);
  hodnoty.<span style="color:#007">put</span>(5, <span style="background-color:#e0e0ff">&#34;piatak&#34;</span>);

  <span style="color:#289;font-weight:bold">return</span> hodnoty;
}</code></pre></div>
<p>V kontroléri stačí vytvoriť metódu, ktorá vracia buď zoznam objektov alebo mapu. Metódu treba anotovať pomocou <code>@ModelAttribute</code>, kde
určíme názov premennej v modeli, na ktorú sa namapuje výsledný zoznam. Keďže ju chceme namapovať na premennú <code>allYears</code>, jej názov
dodáme do anotácie. V našej metóde vytvoríme klasickú mapu (<code>TreeMap</code> preto, aby sa nám zachovalo poradie kľúčov), kde každej položke
dáme celočíselná identifikátor a reťazcový názov, ktorý sa zobrazí používateľovi.</p>

<p>Táto metóda sa zavolá vždy – aj pred GET požiadavkou, aj pred POST požiadavkou a aj v prípade, že validácia objektu zlyhá.
Ak by sme totiž modelovú mapu napĺňali len v metóde obsluhujúcej GET požiadavku a pri zadávaní dát do formulára by nastala chyba, vo formulári by sa hodnoty v zozname nezobrazili. Použitím takejto špeciálnej metódy však zaistíme korektné naplnenie zoznamu vo všetkých prípadoch.</p>

<h1 id="kontroléry-pre-viacero-akcií">Kontroléry pre viacero akcií</h1>

<p>Jeden kontrolér môže obsluhovať aj viacero akcií. Predstavme si, že by sme chceli v zozname študentov dodať položky pre vymazanie študenta a jeho postup do ďalšieho ročníka. Prvým nápadom by bolo vytvorenie dvoch kontrolérov (jedného pre mazanie a druhého pre postup) a ich namapovanie na dve URL adresy. Spring MVC však ponúka kontroléry, ktoré môžu mať každú metódu namapovanú na samostatnú URL adresu.</p>

<p>Príkladom je nasledovný kontrolér:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@Controller</span>
<span style="color:#f00;background-color:#faa">public class </span>StudentActions {
  <span style="color:#555;font-weight:bold">@Autowired</span>
  <span style="color:#f00;background-color:#faa">private Database </span>database;
  
  <span style="color:#555;font-weight:bold">@RequestMapping</span>(<span style="background-color:#e0e0ff">&#34;/deleteStudent.do&#34;</span>)
  <span style="color:#f00;background-color:#faa">public String </span>delete(<span style="color:#f00;background-color:#faa">Long studentId</span>) {
    database.<span style="color:#007">removeStudent</span>(<span style="color:#289;font-weight:bold">new</span> Student(studentId));
    <span style="color:#289;font-weight:bold">return</span> <span style="background-color:#e0e0ff">&#34;redirect:listStudents.do&#34;</span>;
  }
  
  <span style="color:#555;font-weight:bold">@RequestMapping</span>(<span style="background-color:#e0e0ff">&#34;/advanceStudent.do&#34;</span>)
  <span style="color:#f00;background-color:#faa">public String </span>advance(<span style="color:#f00;background-color:#faa">Long studentId</span>) {
    <span style="color:#f00;background-color:#faa">Student student </span><span style="color:#333">=</span> database.<span style="color:#007">findById</span>(studentId);
    student.<span style="color:#007">setYear</span>(student.<span style="color:#007">getYear</span>() <span style="color:#333">+</span> 1);
    <span style="color:#289;font-weight:bold">return</span> <span style="background-color:#e0e0ff">&#34;redirect:listStudents.do&#34;</span>;
  }
}</code></pre></div>
<p>Metóda <code>delete()</code> je namapovaná na URL končiacu sa na <code>/deleteStudent.do</code> a očakáva parameter <code>studentId</code>. Druhá metóda sa vykoná analogicky pri zavolaní URL adresy typu <code>http://.../advanceStudent.do?studentId=2</code>.</p>

<p>Odkaz na tento kontrolér môžeme zaviesť do JSP stránky so zoznamom študentov, stačí do tabuľky dodať nové bunky:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#666;font-style:italic">&lt;!-- hodnota atribútu href nesmie byť na viacerých riadkoch! --&gt;</span>
<span style="color:#070">&lt;td&gt;&lt;a</span> <span style="color:#007">href=</span><span style="background-color:#e0e0ff">&#39;deleteStudent.do?studentId=
</span><span style="background-color:#e0e0ff">  &lt;c:out value=&#34;${student.id}&#34; /&gt;&#39;</span><span style="color:#070">&gt;</span>[ Delete ]<span style="color:#070">&lt;/a&gt;&lt;/td&gt;</span>
<span style="color:#666;font-style:italic">&lt;!-- hodnota atribútu href nesmie byť na viacerých riadkoch! --&gt;</span>
<span style="color:#070">&lt;td&gt;&lt;a</span> <span style="color:#007">href=</span><span style="background-color:#e0e0ff">&#39;advanceStudent.do?studentId=
</span><span style="background-color:#e0e0ff">  &lt;c:out value=&#34;${student.id}&#34; /&gt;&#39;</span><span style="color:#070">&gt;</span>[ Advance to next year ]<span style="color:#070">&lt;/a&gt;&lt;/td&gt;</span></code></pre></div>
<h1 id="literatúra">Literatúra</h1>

<ul>
<li><a href="http://static.springframework.org/spring/docs/2.5.x/reference/mvc.html">Spring MVC Framework</a> - dokumentácia</li>
<li><a href="http://blog.springsource.com/main/2007/11/14/annotated-web-mvc-controllers-in-spring-25/">Annotated Web MVC Controllers in Spring 2.5</a></li>
</ul>

</main>

    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
    </footer>
  </body>
</html>

